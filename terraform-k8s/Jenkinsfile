pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
spec:
  containers:
  - name: terraform
    image: hashicorp/terraform:1.6
    command:
    - cat
    tty: true
    env:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: aws-credentials
          key: AWS_ACCESS_KEY_ID
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: aws-credentials
          key: AWS_SECRET_ACCESS_KEY
    - name: AWS_DEFAULT_REGION
      valueFrom:
        secretKeyRef:
          name: aws-credentials
          key: AWS_DEFAULT_REGION
    - name: TF_BACKEND_BUCKET
      valueFrom:
        configMapKeyRef:
          name: terraform-backend-config
          key: TF_BACKEND_BUCKET
    - name: TF_BACKEND_KEY
      valueFrom:
        configMapKeyRef:
          name: terraform-backend-config
          key: TF_BACKEND_KEY
    - name: TF_BACKEND_REGION
      valueFrom:
        configMapKeyRef:
          name: terraform-backend-config
          key: TF_BACKEND_REGION
    - name: TF_BACKEND_DYNAMODB_TABLE
      valueFrom:
        configMapKeyRef:
          name: terraform-backend-config
          key: TF_BACKEND_DYNAMODB_TABLE
    volumeMounts:
    - name: terraform-backend-config
      mountPath: /etc/terraform
  volumes:
  - name: terraform-backend-config
    configMap:
      name: terraform-backend-config
'''
        }
    }

    environment {
        TERRAFORM_REPO = 'https://github.com/acwarya/terraform-k8s-aws.git'
        TERRAFORM_BRANCH = 'main'
    }

    stages {
        stage('Cleanup Workspace') {
            steps {
                echo 'Cleaning workspace...'
                deleteDir()
            }
        }

        stage('Clone Terraform Repository') {
            steps {
                echo 'Cloning Terraform code from GitHub...'
                echo "Repository: ${TERRAFORM_REPO}"
                echo "Branch: ${TERRAFORM_BRANCH}"
                
                dir('terraform-code') {
                    git url: "${TERRAFORM_REPO}", branch: "${TERRAFORM_BRANCH}"
                }
                
                echo 'Repository cloned successfully'
                sh 'ls -la terraform-code'
            }
        }

        stage('Terraform Init') {
            steps {
                container('terraform') {
                    dir('terraform-code') {
                        echo 'Initializing Terraform...'
                        sh 'terraform version'
                        
                        // Option 1: Using backend config file from mounted volume
                        sh '''
                            echo "Backend configuration from file:"
                            cat /etc/terraform/backend-config.hcl || echo "Config file not found, using env vars"
                            
                            # Initialize with backend config
                            if [ -f /etc/terraform/backend-config.hcl ]; then
                                terraform init -no-color -backend-config=/etc/terraform/backend-config.hcl
                            else
                                # Fallback to environment variables
                                terraform init -no-color \
                                    -backend-config="bucket=${TF_BACKEND_BUCKET}" \
                                    -backend-config="key=${TF_BACKEND_KEY}" \
                                    -backend-config="region=${TF_BACKEND_REGION}" \
                                    -backend-config="dynamodb_table=${TF_BACKEND_DYNAMODB_TABLE}" \
                                    -backend-config="encrypt=true"
                            fi
                        '''
                    }
                }
            }
        }

        stage('Terraform Validate') {
            steps {
                container('terraform') {
                    dir('terraform-code') {
                        echo 'Validating Terraform configuration...'
                        sh 'terraform validate -no-color'
                    }
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                container('terraform') {
                    dir('terraform-code') {
                        echo 'Creating Terraform execution plan...'
                        sh 'terraform plan -no-color -out=tfplan'
                        
                        echo 'Terraform plan created successfully'
                        echo 'Plan saved to: tfplan'
                    }
                }
            }
        }

        stage('Approval for Apply') {
            steps {
                script {
                    echo 'Waiting for approval to apply changes...'
                    input message: 'Do you want to apply the Terraform plan?', 
                          ok: 'Apply',
                          submitter: 'admin'
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                container('terraform') {
                    dir('terraform-code') {
                        echo 'Applying Terraform changes...'
                        sh 'terraform apply -no-color -auto-approve tfplan'
                        echo 'Terraform apply completed successfully!'
                    }
                }
            }
        }

        stage('Approval for Destroy') {
            steps {
                script {
                    echo 'Do you want to destroy the infrastructure?'
                    input message: 'WARNING: This will destroy all resources. Continue?',
                          ok: 'Destroy',
                          submitter: 'admin'
                }
            }
        }

        stage('Terraform Destroy') {
            steps {
                container('terraform') {
                    dir('terraform-code') {
                        echo 'Destroying Terraform infrastructure...'
                        sh 'terraform destroy -no-color -auto-approve'
                        echo 'Infrastructure destroyed successfully!'
                    }
                }
            }
        }

        stage('Display Outputs and Save Keys') {
            when {
                expression { 
                    return currentBuild.result != 'FAILURE' && 
                           currentBuild.getPreviousBuild()?.result != 'ABORTED'
                }
            }
            steps {
                container('terraform') {
                    dir('terraform-code') {
                        script {
                            echo 'Retrieving Terraform outputs...'
                            
                            // Display all outputs
                            sh '''
                                echo "=== Terraform Outputs ==="
                                terraform output -no-color || echo "No outputs available"
                            '''
                            
                            // Save SSH key if available
                            def sshKeyExists = sh(
                                script: 'terraform output -raw private_key_pem 2>/dev/null',
                                returnStatus: true
                            ) == 0
                            
                            if (sshKeyExists) {
                                echo 'Saving SSH private key...'
                                sh '''
                                    terraform output -raw private_key_pem > ssh-key.pem
                                    chmod 600 ssh-key.pem
                                    ls -lh ssh-key.pem
                                '''
                                
                                // Archive the SSH key as a Jenkins artifact
                                archiveArtifacts artifacts: 'ssh-key.pem', 
                                               fingerprint: true,
                                               allowEmptyArchive: true
                                
                                echo 'SSH key saved as Jenkins artifact'
                                echo 'You can download it from the build artifacts'
                            } else {
                                echo 'No SSH key output found'
                            }
                            
                            // Display cluster connection info if available
                            sh '''
                                echo ""
                                echo "=== Cluster Information ==="
                                terraform output -no-color cluster_endpoint 2>/dev/null || echo "Cluster endpoint: Not available"
                                terraform output -no-color cluster_name 2>/dev/null || echo "Cluster name: Not available"
                                echo ""
                            '''
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            container('terraform') {
                dir('terraform-code') {
                    echo 'Cleaning up...'
                    sh 'rm -f tfplan'
                }
            }
        }
        success {
            echo 'Pipeline completed successfully! âœ“'
        }
        failure {
            echo 'Pipeline failed! Check logs above.'
        }
        aborted {
            echo 'Pipeline was aborted.'
        }
    }
}
